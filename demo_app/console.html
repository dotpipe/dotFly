<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Server Console</title>
    <link rel="stylesheet" href="/demo_app/assets/style.css">
</head>
<body>
    <div id="consoleWrap">
        <h1>ğŸ›¡ï¸ Server Console</h1>
        <tabs id="consoleTabs" tab="ğŸš€ API Tester:apiTab:/demo_app/pages/console_api.json;ğŸ“š Docs:docsTab:/demo_app/pages/console_docs.json;ğŸ“œ History:historyTab:/demo_app/pages/console_history.json"></tabs>
    </div>

    <script src="/dotpipe.js"></script>
    <script>
        // Initialize dotPipe when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function init() {
            console.log('Initializing dotPipe...');
            
            // Process tabs and other dotPipe components
            if (typeof domContentLoad === 'function') {
                domContentLoad();
                console.log('domContentLoad() called');
            }
            
            // Register pipe elements
            if (typeof addPipe === 'function') {
                addPipe(document.body);
                console.log('addPipe() called');
            }
            
            console.log('Console initialized successfully');
            
            // API button handlers
            window.sendRequest = function() {
                console.log('ğŸš€ sendRequest called');
                const ep = document.getElementById('endpoint');
                const m = document.getElementById('method');
                const rd = document.getElementById('requestData');
                const rc = document.getElementById('responseContent');
                if (!ep || !m || !rd || !rc) {
                    console.error('âŒ Missing elements');
                    return;
                }
                rc.textContent = '[SENDING] ' + m.value + ' ' + ep.value + '...';
                let opts = {
                    method: m.value,
                    headers: {'Content-Type': 'application/json'}
                };
                if (m.value === 'POST' && rd.value.trim()) {
                    opts.body = rd.value;
                }
                console.log('Fetching:', ep.value, opts);
                fetch(ep.value, opts)
                    .then(r => r.text())
                    .then(text => {
                        console.log('âœ… Response:', text.substring(0, 200));
                        try {
                            const data = JSON.parse(text);
                            rc.textContent = '[SUCCESS]\n' + JSON.stringify(data, null, 2);
                        } catch(e) {
                            rc.textContent = '[RESPONSE]\n' + text;
                        }
                    })
                    .catch(e => {
                        console.error('âŒ Fetch error:', e);
                        rc.textContent = '[ERROR] ' + e.message;
                    });
            };
            
            window.clearAll = function() {
                console.log('ğŸ”„ clearAll called');
                const rd = document.getElementById('requestData');
                const rc = document.getElementById('responseContent');
                if (rd) rd.value = '';
                if (rc) rc.textContent = '[CLEARED] Ready for new request...';
            };
            
            window.loadExample = function() {
                console.log('ğŸ“‹ loadExample called');
                const ep = document.getElementById('endpoint');
                const rd = document.getElementById('requestData');
                if (!ep || !rd) return;
                const examples = {
                    'http://chat.chessers.club/api/message.php': JSON.stringify({
                        message: 'Hello from dotFly at ' + new Date().toLocaleTimeString(),
                        sender: 'dotFly_user'
                    }, null, 2)
                };
                rd.value = examples[ep.value] || JSON.stringify({message: 'Test', sender: 'guest'}, null, 2);
            };
            
            // Global click handler for all buttons
            document.addEventListener('click', function(e) {
                console.log('ğŸ‘† Click detected:', e.target.id, e.target.tagName, e.target);
                if (e.target.id === 'sendBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Calling sendRequest...');
                    sendRequest();
                    return false;
                } else if (e.target.id === 'clearBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    clearAll();
                    return false;
                } else if (e.target.id === 'loadBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    loadExample();
                    return false;
                }
            }, true);
            
            // Test the API endpoint
            setTimeout(() => {
                console.log('Testing API endpoint...');
                fetch('http://chat.chessers.club/api/status.php')
                    .then(r => {
                        console.log('Response status:', r.status);
                        return r.json();
                    })
                    .then(data => {
                        console.log('âœ… API CONNECTED:', data);
                    })
                    .catch(e => console.error('âŒ API Error:', e));
            }, 2000);
        }
    </script>
</body>
</html>
