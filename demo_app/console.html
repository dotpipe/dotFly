<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Server Console</title>
    <link rel="stylesheet" href="/dotfly/demo_app/assets/style.css">
</head>
<body>
    <div id="consoleWrap">
        <h1>ğŸ›¡ï¸ Server Console</h1>
        <tabs id="consoleTabs" tab="ğŸš€ API Tester:apiTab:/demo_app/pages/console_api.json;ğŸ“š Docs:docsTab:/demo_app/pages/console_docs.json;ğŸ“œ History:historyTab:/demo_app/pages/console_history.json"></tabs>
    </div>

    <script src="/dotpipe.js"></script>
    <script>
        // Initialize dotPipe when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        function init() {
            console.log('Initializing dotPipe...');
            
            // Process tabs and other dotPipe components
            if (typeof domContentLoad === 'function') {
                domContentLoad();
                console.log('domContentLoad() called');
            }
            
            // Register pipe elements
            if (typeof addPipe === 'function') {
                addPipe(document.body);
                console.log('addPipe() called');
            }
            
            console.log('Console initialized successfully');
            
            // Request history storage
            window.requestHistory = [];
            
            window.updateHistory = function() {
                const historyContent = document.getElementById('historyContent');
                if (!historyContent) return;
                
                // Clear only the data rows, keep existing headers
                const rows = historyContent.querySelectorAll('tr');
                rows.forEach((row, i) => {
                    if (i > 0) { // Keep first row (title from JSON)
                        row.remove();
                    }
                });
                
                if (requestHistory.length === 0) {
                    const emptyRow = document.createElement('tr');
                    const emptyCell = document.createElement('td');
                    emptyCell.colSpan = 4;
                    emptyCell.textContent = 'Send a request to see history...';
                    emptyRow.appendChild(emptyCell);
                    historyContent.appendChild(emptyRow);
                    return;
                }
                
                // Add header row
                const headerRow = document.createElement('tr');
                headerRow.style.background = '#333';
                ['Time', 'Method', 'Endpoint', 'Status'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                historyContent.appendChild(headerRow);
                
                // Add history entries (newest first)
                requestHistory.slice().reverse().forEach(entry => {
                    const row = document.createElement('tr');
                    
                    const timeCell = document.createElement('td');
                    timeCell.textContent = entry.time;
                    row.appendChild(timeCell);
                    
                    const methodCell = document.createElement('td');
                    methodCell.textContent = entry.method;
                    row.appendChild(methodCell);
                    
                    const urlCell = document.createElement('td');
                    urlCell.textContent = entry.url.replace('http://chat.chessers.club/api/', '');
                    row.appendChild(urlCell);
                    
                    const statusCell = document.createElement('td');
                    statusCell.textContent = entry.status;
                    statusCell.style.color = entry.success ? '#0f0' : '#f00';
                    row.appendChild(statusCell);
                    
                    historyContent.appendChild(row);
                });
            };
            
            // API button handlers
            window.sendRequest = function() {
                console.log('ğŸš€ sendRequest called');
                const ep = document.getElementById('endpoint');
                const m = document.getElementById('method');
                const rd = document.getElementById('requestData');
                const rc = document.getElementById('responseContent');
                if (!ep || !m || !rd || !rc) {
                    console.error('âŒ Missing elements');
                    console.error('ep:', ep, 'm:', m, 'rd:', rd, 'rc:', rc);
                    return;
                }
                const url = ep.value;
                const method = m.value;
                console.log('ğŸ“ Endpoint element value:', url);
                console.log('ğŸ“ Full URL being fetched:', url);
                console.log('ğŸ“ Method:', method);
                console.log('ğŸ“ Request data:', rd.value);
                
                if (!url || !url.startsWith('http')) {
                    rc.textContent = '[ERROR] Invalid URL: ' + url;
                    console.error('Invalid URL detected:', url);
                    return;
                }
                
                rc.textContent = '[SENDING] ' + method + ' ' + url + '...';
                let opts = {
                    method: method,
                    headers: {'Content-Type': 'application/json'}
                };
                if (method === 'POST') {
                    if (rd.value.trim()) {
                        opts.body = rd.value;
                    } else {
                        rc.textContent = '[ERROR] POST request requires data in the Request Data field';
                        return;
                    }
                }
                console.log('Fetching URL:', url);
                console.log('Fetch options:', JSON.stringify(opts, null, 2));
                
                const startTime = new Date();
                fetch(url, opts)
                    .then(r => r.text())
                    .then(text => {
                        console.log('âœ… Response:', text.substring(0, 200));
                        
                        // Add to history
                        requestHistory.push({
                            time: startTime.toLocaleTimeString(),
                            method: method,
                            url: url,
                            status: 'âœ… SUCCESS',
                            success: true
                        });
                        updateHistory();
                        
                        try {
                            const data = JSON.parse(text);
                            rc.textContent = '[SUCCESS]\n' + JSON.stringify(data, null, 2);
                        } catch(e) {
                            rc.textContent = '[RESPONSE]\n' + text;
                        }
                    })
                    .catch(e => {
                        console.error('âŒ Fetch error:', e);
                        
                        // Add error to history
                        requestHistory.push({
                            time: startTime.toLocaleTimeString(),
                            method: method,
                            url: url,
                            status: 'âŒ ' + e.message,
                            success: false
                        });
                        updateHistory();
                        
                        rc.textContent = '[ERROR] ' + e.message;
                    });
            };
            
            window.clearAll = function() {
                console.log('ğŸ”„ clearAll called');
                const rd = document.getElementById('requestData');
                const rc = document.getElementById('responseContent');
                if (rd) rd.value = '';
                if (rc) rc.textContent = '[CLEARED] Ready for new request...';
            };
            
            window.loadExample = function() {
                console.log('ğŸ“‹ loadExample called');
                const ep = document.getElementById('endpoint');
                const rd = document.getElementById('requestData');
                if (!ep || !rd) return;
                const examples = {
                    'http://chat.chessers.club/api/message.php': JSON.stringify({
                        message: 'Hello from dotFly at ' + new Date().toLocaleTimeString(),
                        sender: 'dotFly_user'
                    }, null, 2)
                };
                rd.value = examples[ep.value] || JSON.stringify({message: 'Test', sender: 'guest'}, null, 2);
            };
            
            // Auto-switch to POST and load example when endpoint changes
            document.addEventListener('change', function(e) {
                if (e.target.id === 'endpoint') {
                    const ep = e.target.value;
                    const method = document.getElementById('method');
                    console.log('ğŸ“ Endpoint changed to:', ep);
                    
                    // Auto-switch to POST for endpoints that need it
                    if (ep.includes('message.php') || ep.includes('user.php')) {
                        if (method) method.value = 'POST';
                        console.log('âœ… Auto-switched to POST');
                        // Auto-load example
                        setTimeout(loadExample, 100);
                    } else {
                        if (method) method.value = 'GET';
                        console.log('âœ… Auto-switched to GET');
                    }
                }
            });
            
            // Global click handler for all buttons
            document.addEventListener('click', function(e) {
                console.log('ğŸ‘† Click detected:', e.target.id, e.target.tagName, e.target);
                if (e.target.id === 'sendBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Calling sendRequest...');
                    sendRequest();
                    return false;
                } else if (e.target.id === 'clearBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    clearAll();
                    return false;
                } else if (e.target.id === 'loadBtn') {
                    e.preventDefault();
                    e.stopPropagation();
                    loadExample();
                    return false;
                }
            }, true);
            
            // Test the API endpoint
            setTimeout(() => {
                console.log('Testing API endpoint...');
                fetch('http://chat.chessers.club/api/status.php')
                    .then(r => {
                        console.log('Response status:', r.status);
                        return r.json();
                    })
                    .then(data => {
                        console.log('âœ… API CONNECTED:', data);
                    })
                    .catch(e => console.error('âŒ API Error:', e));
            }, 2000);
        }
    </script>
</body>
</html>
